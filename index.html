<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>My Little Game</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #1a1a1a, #2c2c2c); /* 渐变背景 */
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      max-width: 500px;
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px); /* 毛玻璃效果 */
    }
    h2 {
      text-align: center;
      color: #fff; /* 改为白色 */
    }
    .settings {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .settings label, .settings input {
      font-size: 1.1em;
      color: #ddd;
      margin: 0.3em 0;
      display: block;
      width: 100%;
    }
    .settings input {
      padding: 8px;
      border: none;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      box-sizing: border-box;
    }
    .settings button {
      font-size: 1.1em;
      padding: 10px;
      background: #fff; /* 改为白色 */
      color: #111;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .settings button:hover {
      background: #e0e0e0; /* 悬停时浅灰色 */
    }
    #progress-container {
      width: 100%;
      margin-top: 1em;
      padding: 0; /* 移除内边距以占满宽度 */
      box-sizing: border-box;
    }
    #progress {
      width: 100%;
      height: 60px; /* 增加高度 */
      margin: 20px 0;
      border-radius: 30px; /* 调整圆角 */
      background: rgba(255, 255, 255, 0.2);
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    #bar {
      height: 100%;
      width: 100%;
      background: green;
      transition: width 0.1s linear;
      border-radius: 30px;
    }
    #status {
      font-size: 1.8em;
      margin-bottom: 1em;
      color: #fff; /* 改为白色 */
      /* 移除text-shadow */
    }
    #countdown {
      font-size: 2.5em;
      font-weight: bold;
      margin-top: 0.5em;
      color: #fff; /* 确保白色 */
    }
    .hidden {
      display: none;
    }
    #auth-container input {
      padding: 0.8em;
      font-size: 1.2em;
      width: 100%;
      max-width: 300px;
      border: none;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
    }
    #auth-container button {
      padding: 0.6em 1.2em;
      font-size: 1.2em;
      margin-top: 1em;
      background: #fff; /* 改为白色 */
      color: #111;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    #auth-container button:hover {
      background: #e0e0e0; /* 悬停时浅灰色 */
    }
    /* 响应式设计 */
    @media (max-width: 600px) {
      .container {
        padding: 15px;
      }
      .settings input, .settings button {
        font-size: 0.9em;
      }
      #status {
        font-size: 1.5em;
      }
      #countdown {
        font-size: 2em;
      }
    }
  </style>
</head>
<body>
  <!-- 添加多个音频文件 -->
  <audio id="releaseSound1" src="/edgewebtest/assets/countdown1.mp3" preload="auto" onloadedmetadata="storeDuration('releaseSound1')"></audio>
  <audio id="releaseSound2" src="/edgewebtest/assets/countdown2.mp3" preload="auto" onloadedmetadata="storeDuration('releaseSound2')"></audio>
  <audio id="releaseSound3" src="/edgewebtest/assets/countdown3.mp3" preload="auto" onloadedmetadata="storeDuration('releaseSound3')"></audio>
  <audio id="releaseSound4" src="/edgewebtest/assets/countdown4.mp3" preload="auto" onloadedmetadata="storeDuration('releaseSound4')"></audio>
  <audio id="releaseSound5" src="/edgewebtest/assets/countdown5.mp3" preload="auto" onloadedmetadata="storeDuration('releaseSound5')"></audio>

  <div class="container">
    <div id="auth-container">
      <h2>请输入密码进入</h2>
      <input type="password" id="passwordInput" placeholder="密码" />
      <button onclick="checkPassword()">进入</button>
      <p id="auth-error" style="color:red;"></p>
    </div>

    <div id="main-container" class="hidden">
      <div class="settings">
        <label>总时间（分钟）:</label><input id="totalTime" type="number" value="10" min="1" max="60" />
        <label>释放机会概率（%）:</label><input id="chanceTrigger" type="number" value="30" min="0" max="100" />
        <label>释放成功概率（%）:</label><input id="chanceAllow" type="number" value="50" min="0" max="100" />
        <label>释放倒计时（秒）:</label><input id="releaseDuration" type="number" value="16" min="5" max="60" />
        <button onclick="startGame()">开始</button>
      </div>

      <div id="progress-container">
        <div id="status">等待开始...</div>
        <div id="progress"><div id="bar"></div></div>
      </div>
      <div id="countdown"></div>
    </div>
  </div>

  <script>
    const correctPassword = "00000000";
    let audioContextInitialized = false;

    // 存储音频时长的对象
    const soundDurations = {};

    // 音频元素数组
    const releaseSounds = [
      document.getElementById("releaseSound1"),
      document.getElementById("releaseSound2"),
      document.getElementById("releaseSound3"),
      document.getElementById("releaseSound4"),
      document.getElementById("releaseSound5")
    ];

    // 存储音频时长
    function storeDuration(soundId) {
      const audio = document.getElementById(soundId);
      soundDurations[soundId] = audio.duration || 16; // 默认16秒如果未加载
    }

    function checkPassword() {
      const input = document.getElementById("passwordInput").value;
      const errorText = document.getElementById("auth-error");
      if (input === correctPassword) {
        document.getElementById("auth-container").style.display = "none";
        document.getElementById("main-container").classList.remove("hidden");
        initializeAudioContext();
      } else {
        errorText.textContent = "密码错误，请重试。";
      }
    }

    function initializeAudioContext() {
      if (!audioContextInitialized) {
        releaseSounds.forEach(sound => sound.load());
        audioContextInitialized = true;
      }
    }

    function playReleaseSound() {
      // 停止所有音频播放
      releaseSounds.forEach(sound => {
        sound.pause();
        sound.currentTime = 0;
      });

      // 随机选择一个音频
      const randomIndex = Math.floor(Math.random() * releaseSounds.length);
      const selectedSound = releaseSounds[randomIndex];
      const soundId = selectedSound.id;
      const duration = soundDurations[soundId] || 16; // 使用存储的时长或默认16秒

      // 更新 releaseDuration 为音频时长 + 1秒
      releaseDuration = Math.ceil(duration) + 1;

      // 播放选中的音频
      selectedSound.play().catch(error => {
        console.error("释放音效播放失败:", error);
      });
    }

    let totalDuration, chanceTrigger, chanceAllow, releaseDuration;
    let startTime;
    let mode = 'green';
    let bar, status, countdown;
    let interval;
    let inReleasePhase = false;
    let phaseCount = 0;
    let isFirstPhase = true;

    const greenMessages = {
      early: ['慢慢撸，现在只是热身', '抓住你的鸡巴，从上到下撸动它'],
      mid: ['继续保持，别太快', '平稳前进'],
      late: ['坚持住，准备高潮', '深呼吸，保持冷静']
    };

    const redMessages = {
      early: ['暂停触碰，深呼吸'],
      mid: ['保持冷静，等待信号'],
      late: ['放松身体，控制自己']
    };

    function startGame() {
      totalDuration = parseInt(document.getElementById("totalTime").value) * 60 * 1000;
      chanceTrigger = parseInt(document.getElementById("chanceTrigger").value);
      chanceAllow = parseInt(document.getElementById("chanceAllow").value);
      releaseDuration = parseInt(document.getElementById("releaseDuration").value);

      bar = document.getElementById("bar");
      status = document.getElementById("status");
      countdown = document.getElementById("countdown");

      document.querySelector('.settings').classList.add('hidden');
      startTime = Date.now();

      status.innerText = "准备开始...";
      phaseCount = 0;
      isFirstPhase = true;
      nextPhase();
    }

    function getPhaseProgress() {
      const elapsed = Date.now() - startTime;
      return elapsed / totalDuration;
    }

    function getRandomMessage(mode) {
      const progress = getPhaseProgress();
      const messages = mode === 'green' ? greenMessages : redMessages;
      const phase = progress <= 0.3 ? 'early' : progress <= 0.8 ? 'mid' : 'late';
      const msgList = messages[phase];
      return msgList[Math.floor(Math.random() * msgList.length)];
    }

    function nextPhase() {
      if (interval) clearInterval(interval);

      const now = Date.now();
      const elapsed = now - startTime;
      const progress = elapsed / totalDuration;

      if (progress > 1 && mode === 'green') {
        if (Math.random() < chanceTrigger / 100) {
          inReleasePhase = true;
          const allow = Math.random() < chanceAllow / 100;
          if (allow) {
            status.innerText = '你可以释放了！';
            playReleaseSound(); // 随机播放音频并设置 releaseDuration
          } else {
            status.innerText = '不太走运，不能释放';
          }
          startCountdown(releaseDuration, true);
          return;
        }
      }

      if (!isFirstPhase) {
        mode = mode === 'green' ? 'red' : 'green';
      }
      isFirstPhase = false;

      bar.style.background = mode === 'green' ? 'green' : 'red';
      status.innerText = getRandomMessage(mode);

      phaseCount++;
      const duration = getPhaseDuration();
      startCountdown(duration, false);
    }

    function getPhaseDuration() {
      const progress = getPhaseProgress();
      const phase = progress <= 0.3 ? 'early' : progress <= 0.8 ? 'mid' : 'late';
      const remainRatio = 1 - progress;

      const phaseDurations = {
        early: {
          green: { min: 40, max: 50 },
          red: { min: 20, max: 30 }
        },
        mid: {
          green: { min: 30, max: 40 },
          red: { min: 15, max: 25 }
        },
        late: {
          green: { min: 20, max: 30 },
          red: { min: 10, max: 20 }
        }
      };

      const durationRange = phaseDurations[phase][mode];

      if (phaseCount > 3) {
        const baseMin = durationRange.min * remainRatio;
        const baseMax = durationRange.max * remainRatio;
        const min = Math.max(5, Math.floor(baseMin));
        const max = Math.max(min, Math.floor(baseMax));
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      return Math.floor(Math.random() * (durationRange.max - durationRange.min + 1)) + durationRange.min;
    }

    function startCountdown(seconds, isFinal = false) {
      let current = seconds;
      countdown.innerText = current + " 秒";
      bar.style.width = '100%';

      const start = Date.now();
      const duration = seconds * 1000;

      interval = setInterval(() => {
        const elapsed = Date.now() - start;
        const progress = 1 - elapsed / duration;
        bar.style.width = (progress * 100) + "%";
        countdown.innerText = Math.ceil(current) + " 秒";

        current -= 1 / 60;

        if (progress <= 0) {
          clearInterval(interval);
          bar.style.width = '0%';
          if (isFinal) {
            status.innerText += "\n游戏结束。";
            releaseSounds.forEach(sound => {
              sound.pause();
              sound.currentTime = 0;
            });
          } else {
            nextPhase();
          }
        }
      }, 1000 / 60);
    }
  </script>
</body>
</html>
