<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>边缘游戏</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #111;
      color: white;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .settings {
      margin-bottom: 20px;
    }
    label, input {
      margin: 5px;
    }
    #progress-container {
      width: 100%;
    }
    #progress {
      width: 100%;
      height: 50px;
      margin: 0 auto;
      border-radius: 25px;
      background: #555;
      overflow: hidden;
    }
    #bar {
      height: 100%;
      width: 100%;
      background: green;
      transition: width 1s linear;
    }
    #status {
      font-size: 2em;
      margin-bottom: 20px;
      line-height: 1.4;
    }
    #countdown {
      font-size: 2.5em;
      margin-top: 20px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="settings">
    <label>总时间（分钟）:</label><input id="totalTime" type="number" value="10" min="1" max="60" />
    <label>释放机会概率（%）:</label><input id="chanceTrigger" type="number" value="30" min="0" max="100" />
    <label>释放成功概率（%）:</label><input id="chanceAllow" type="number" value="50" min="0" max="100" />
    <label>释放倒计时（秒）:</label><input id="releaseDuration" type="number" value="15" min="5" max="60" />
    <button onclick="startGame()">开始</button>
  </div>

  <div id="progress-container">
    <div id="status">等待开始...</div>
    <div id="progress"><div id="bar"></div></div>
  </div>
  <div id="countdown"></div>

  <!-- 音效部分 -->
  <audio id="beep" src="https://freesound.org/data/previews/316/316914_5111566-lq.mp3"></audio>
  <audio id="startGreen" src="https://freesound.org/data/previews/256/256113_4486188-lq.mp3"></audio>
  <audio id="startRed" src="https://freesound.org/data/previews/178/178110_3248244-lq.mp3"></audio>
  <audio id="releaseAllowed" src="https://freesound.org/data/previews/522/522631_11304677-lq.mp3"></audio>
  <audio id="releaseDenied" src="https://freesound.org/data/previews/320/320655_5260877-lq.mp3"></audio>

  <script>
    let mode = 'green';
    let totalDuration = 0;
    let startTime;
    let bar, status, countdown;
    let releaseTriggered = false;
    let chanceTrigger, chanceAllow, releaseDuration;
    let isFirstPhase = true;
    let phaseCount = 0; // 阶段计数器

    const greenMessages = {
      early: ['保持节奏', '轻柔触碰', '慢慢来', '感受每一刻', '控制速度'],
      mid: ['继续保持', '专注感觉', '别太快', '平稳前进', '享受过程'],
      late: ['接近边缘', '坚持住', '深呼吸', '保持冷静', '准备高潮']
    };
    const redMessages = {
      early: ['暂停触碰', '放松一下', '等待信号', '深吸一口气', '稍作停顿'],
      mid: ['保持冷静', '停止动作', '稍作休息', '控制呼吸', '等待时机'],
      late: ['完全停止', '控制自己', '准备结束', '放松身体', '保持耐心']
    };

    function playSound(id) {
      document.getElementById(id).currentTime = 0;
      document.getElementById(id).play();
    }

    function startGame() {
      totalDuration = parseInt(document.getElementById("totalTime").value) * 60 * 1000;
      chanceTrigger = parseInt(document.getElementById("chanceTrigger").value);
      chanceAllow = parseInt(document.getElementById("chanceAllow").value);
      releaseDuration = parseInt(document.getElementById("releaseDuration").value);

      bar = document.getElementById("bar");
      status = document.getElementById("status");
      countdown = document.getElementById("countdown");
      startTime = Date.now();

      document.querySelector('.settings').classList.add('hidden');

      bar.style.background = 'green';
      status.innerText = getRandomMessage(0, 'green');
      isFirstPhase = true;
      phaseCount = 0; // 重置阶段计数器
      nextPhase();
    }

    function getRandomMessage(progress, mode) {
      const messages = mode === 'green' ? greenMessages : redMessages;
      if (progress <= 0.3) return messages.early[Math.floor(Math.random() * messages.early.length)];
      if (progress <= 0.7) return messages.mid[Math.floor(Math.random() * messages.mid.length)];
      return messages.late[Math.floor(Math.random() * messages.late.length)];
    }

    function nextPhase() {
      if (releaseTriggered) return;

      const elapsed = Date.now() - startTime;
      const progress = elapsed / totalDuration;

      if (elapsed >= totalDuration) {
        if (mode === 'green' && Math.random() < chanceTrigger / 100) {
          releaseTriggered = true;
          const allow = Math.random() < chanceAllow / 100;
          if (allow) {
            status.innerText = '你可以释放了！';
            playSound('releaseAllowed');
            countdownPhase(releaseDuration, 'green', true);
          } else {
            status.innerText = '不太走运，不能释放';
            playSound('releaseDenied');
            countdown.innerText = '';
          }
          return;
        }
      }

      if (!isFirstPhase) {
        mode = mode === 'green' ? 'red' : 'green';
      }
      isFirstPhase = false;

      bar.style.background = mode === 'green' ? 'green' : 'red';
      status.innerText = getRandomMessage(progress, mode);
      const remainRatio = 1 - elapsed / totalDuration;

      phaseCount++; // 增加阶段计数
      let duration;
      if (phaseCount === 1) {
        // 第一阶段：45-60秒
        duration = getRandomInt(45, 60);
      } else if (phaseCount === 2) {
        // 第二阶段：20-45秒
        duration = getRandomInt(20, 45);
      } else if (phaseCount === 3) {
        // 第三阶段：5-20秒
        duration = getRandomInt(5, 20);
      } else {
        // 后续阶段：基于剩余时间比例
        duration = mode === 'green'
          ? getRandomInt(10, 60 * remainRatio)
          : getRandomInt(5, 30 * remainRatio);
      }

      countdownPhase(duration, mode);
    }

    function countdownPhase(seconds, currentMode, finalPhase = false) {
      let current = seconds;
      let interval = setInterval(() => {
        bar.style.width = (current / seconds) * 100 + '%';
        countdown.innerText = current + ' 秒';

        if (current <= 3 && current > 2) playSound('beep');

        if (--current < 0) {
          clearInterval(interval);
          if (!finalPhase) nextPhase();
          else status.innerText = '游戏结束';
        }
      }, 1000);
    }

    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
  </script>
</body>
</html>